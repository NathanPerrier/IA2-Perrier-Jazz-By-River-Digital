{% extends 'template/main.html' %} 
{% load static %} 
{% block header %}
    <link rel="stylesheet" href="{% static '//css//landing.css' %}">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="{% static '//css//routes//directions.css' %}" type="text/css">
{% endblock %}
{% block content %}
    <style>
        body {
          overflow-y: hidden !important;
        }
        #map {
            position: absolute;
            top: 0;
            z-index: 300;
            bottom: 0;
            width: calc(100vw - 50px);
            right: 0;
            height: calc(100vh + 30px);
            overflow-y: hidden !important;
        }
        .mapbox-directions-origin {
          background-color: var(--primary);
          color: var(--light);
        }
        p, a {color: black;}
    </style>
    <div id="map" style="overflow-y:hidden"></div>
    <script>
        mapboxgl.accessToken = "{{ mapbox_access_token }}";

        const API_KEY = "{{ tomorrowio_api_key }}";
       

        var latitude = 153.02207;
        var longitude = -27.46917;
        if ('{{ location }}') {
          latitude = '{{ location.lon }}';
          longitude = '{{ location.lat }}';
        } else {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                  latitude = position.coords.latitude;
                  longitude = position.coords.longitude;
              });
          }
        }; 
          
        var route;

        fetch('/chat/setRoute/', {
            method: 'GET', // or 'POST'
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.success) {
                route = data.route;
                mode = data.mode;
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
        
      
        
        var map = new mapboxgl.Map({
            container: 'map',
            center: [latitude,longitude],
            zoom: 7,
            style: 'mapbox://styles/nathan-perrier23/clr7bpszt00ls01ob5pxjboov',
            antialias: true
        });
        
        var directions = new MapboxDirections({
          style: 'mapbox://styles/nathan-perrier23/clr7bpszt00ls01ob5pxjboov',
          accessToken: mapboxgl.accessToken,
          unit: 'metric',
          alternatives: true,
          banner_instructions: true,
          geometries: false,
          controls: { instructions: true },
          flyTo: false,
        });

        if (route) {
          directions.mode = mode;
          directions.setOrigin(route[0]);
          directions.setDestination(route[route.length - 1]);
          directions.setRouteIndex(0);
        }
        
        map.addControl(directions, 'top-right');
    
        directions.on('route', function(e) {
          var route = e.route[0].legs[0].steps //legs?? //.legs[0].steps; 
    
          var origin = directions.getOrigin().geometry.coordinates;
          var destination = directions.getDestination().geometry.coordinates;

          var mode = route[0].mode; 
    
          var coordinates = {
            start: origin,
            end: destination,
            route: route,
            mode: mode
          };

          fetch('/chat/getCoordinates/', {   
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(coordinates)
          })
          .then(response => response.json())
          .then(data => console.log(data.success));
        });
    </script>
    {% include 'chatbot/chat.html' %}
{% endblock %}