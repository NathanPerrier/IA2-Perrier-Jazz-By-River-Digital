{% extends 'template/auth.html' %}
{% load static %} 

{% block header %}
  <link rel="stylesheet" href="{% static '//css//auth//form.css' %}">
  <link rel="stylesheet" href="{% static '//css//auth//multiStepForm.css' %}">
  <link rel="stylesheet" href="{% static '//css//auth//auth.css' %}">
{% endblock %}

{% block content %}
  <div class="container p-0 m-0" id="page">
      <div class="weather-radar">
        <div id="map"></div>
        <div class="right"></div>
      </div>
      <div class="auth-form">
        <div class="logos mt-2">
          <div class="logo">
            <a href="/"><h1>Rain<span class="text-secondary">Check</span></h1></a>
          </div>
          <div class="ms-2"><div class="divider"></div></div>
          <div class="atc ms-2">
            <a href="/atc/"><img src="{% static '//images//logos//atc//atc-crest-white.svg' %}" alt="ATC"></a>
          </div>
        </div>
        <div class="form">
          <form action="" id="multiStepForm" method="POST">
            {% csrf_token %}
            <h1 class="mb-2">Register</h1>
            <!-- Email Step -->
            <div class="tab mb-0">
              <div class="error-div"></div>
              <!--!   removes oninput="this.className = ''" from inputs as it caused the removal of marins. DOES IT EFFECT FORM CONTROL??   !-->
              <input name="first_name" type="text" class="text mb-1" autocomplete="new-password" placeholder="First Name" minlength="2" required />
              <input name="last_name" type="text" class="text mb-1" autocomplete="new-password" placeholder="Last Name" minlength="2" required />
              <input name="email" type="email" class="text mb-2" placeholder="Email" minlength="10" required />
              <button id="nextBtn" onclick="submitEmail()">
                  <span class="buttton__">Next</span>
              </button>
              <a onclick="window.history.back()" class="go_back btn-a mb-0">Go Back</a>
              <p class="message text-center mt-2">Already Have An Account? <a href="/login">Login</a></p>
          </div>

          <!-- Reset Code Step -->
          <div class="tab mb-0">
              <div class="error-div hide"></div>
              <!--<p style="mb-3" style="text-align:center">Please Enter The Signup Code</p>-->
              <input name="reset_code" type="text" class="text mb-3" autocomplete="new-password" placeholder="Reset Code" minlength="6" maxlength="6" required />
              <button id="nextBtn" onclick="submitResetCode()">Next</button>
              <button type="button" class="go_back" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
          </div>

          <!-- New Password Step -->
          <div class="tab mb-0">
              <div class="error-div hide"></div>
              <input name="password" type="password" class="text mb-1" autocomplete="new-password" placeholder="Password" minlength="8" required />
              <input name="confirm_password" type="password" class="text mb-2" autocomplete="new-password" placeholder="Confirm New Password" minlength="8" required />
              <div class="mb-2" style="display: flex; align-items: center;justify-content:center">
                <input style="padding:0; width:40px;" type="checkbox" id="t&c" value="" required>
                <label class='mt-2 ms-2' style="font-size:15px; color:var(--light);" for="invalidCheck2">
                    <a href="/terms and policies/terms and conditions" class="" style="text-decoration: none; color:#fff">
                        <p style="color:#fff">Agree to terms and conditions</p>
                    </a>
                </label>
              </div>
              <button type="button" id="nextBtn" class="button" onclick="submitNewPassword()">
                  <span class="buttton__text">Submit</span>
              </button>
          </div>
                                              

          <div class="mt-2" style="text-align:center;">
              <span class="step"></span>
              <span class="step"></span>
              <span class="step"></span>
          </div>
          </form>
      </div>
  </div>
  <script>
      document.getElementsByClassName("error-div")[0].style.display = "none";

      mapboxgl.accessToken = "{{ mapbox_access_token }}";

      const API_KEY = "{{ tomorrowio_api_key }}";

      // pick the field (like temperature, precipitationIntensity or cloudCover)
      const DATA_FIELD = 'precipitationIntensity';

      // set the ISO timestamp (now for all fields, up to 6 hour out for precipitationIntensity)
      const TIMESTAMP = (new Date()).toISOString();

        var latitude = 153.02207;
        var longitude = -27.46917;
        if ('{{ location }}') {
          latitude = '{{ location.lon }}';
          longitude = '{{ location.lat }}';
        } else {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                  latitude = position.coords.latitude;
                  longitude = position.coords.longitude;
              });
          }
        }; 
    

      // initialize the map
      var map = (window.map = new mapboxgl.Map({
        container: 'map',
        zoom: 7,
        center: [latitude, longitude],
        style: 'mapbox://styles/nathan-perrier23/clr7wfpx6000101ood22cfm8u', // mapbox://styles/nathan-perrier23/clqthibtm00ci01pp38f03g3w LEGACY
        antialias: true
      }));

      // inject the tile layer
      map.on('load', function() {
        map.addSource('tomorrow-io-api', {
            "type": 'raster',
            "tiles": [`https://api.tomorrow.io/v4/map/tile/{z}/{x}/{y}/${DATA_FIELD}/${TIMESTAMP}.png?apikey=${API_KEY}`],
            "tileSize": 256,
            "attribution": '&copy; <a href="http://127.0.0.1:8000/atc/">Powered by Ambrose Treacy College</a>'
        });
        map.addLayer({
            "id": "radar-tiles",
            "type": "raster",
            "source": "tomorrow-io-api",
            "minzoom": 1,
            "maxzoom": 12
        });
      });
  

      function submitEmail() {
          const theButton = document.querySelector(".button");

          var first_name = document.querySelector('input[name="first_name"]').value;
          var last_name = document.querySelector('input[name="last_name"]').value;

          if (!first_name || !last_name) {
              document.getElementsByClassName("error-div").style.display = "block";
              document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center">Please Enter Your Name</p>`;
              thebutton.prop("disabled", false);
          }

          var emailData = new FormData();
          emailData.append('first_name', first_name);
          emailData.append('last_name', last_name);
          emailData.append('email', document.querySelector('input[name="email"]').value);

          fetch('/register/get_email/', {
            method: 'POST',
            body: emailData,
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementsByClassName("error-div")[0].style.display = "none";
              nextPrev(1);
              thebutton.prop("disabled", false);
              
            } else {
              document.getElementsByClassName("error-div")[0].style.display = "block";
              document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center">${data.error}</p>`;
              thebutton.prop("disabled", false)
            }
          });
          
      }

      function submitResetCode() {
          var codeData = new FormData();
          codeData.append('code', document.querySelector('input[name="reset_code"]').value);
          codeData.append('email', document.querySelector('input[name="email"]').value);

          fetch('/register/get_code/', {
              method: 'POST',
              body: codeData,
              headers: { 'X-CSRFToken': getCookie('csrftoken') },
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  document.getElementsByClassName("error-div")[0].style.display = "none";
                  nextPrev(1)
              } else {
                var elements = document.getElementsByClassName("error-div");
                for (var i = 0; i < elements.length; i++) {
                    elements[i].classList.remove("hide");
                };
                alert(data.error);
                document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center text-white" style="color:white">${data.error}</p>`;
                document.getElementsByClassName("error-div")[0].style.display = "block";
              }
          });
      }

      function submitNewPassword() {

          const theButton = document.querySelector(".button");

          var password = document.querySelector('input[name="password"]').value;
          var confirmPassword = document.querySelector('input[name="confirm_password"]').value;
          var termsAndConditions = document.getElementById('t&c');
          
          if (!password) {
              var elements = document.getElementsByClassName("error-div");
              for (var i = 0; i < elements.length; i++) {
                  elements[i].classList.remove("hide");
              };
              document.getElementsByClassName("error-div")[0].style.display = "block";
              document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center">Please Enter a Password</p>`;
              thebutton.prop("disabled", false);
          }
          

          if (password !== confirmPassword) {
              alert('Passwords Do Not Match');
              var elements = document.getElementsByClassName("error-div");
              for (var i = 0; i < elements.length; i++) {
                  elements[i].classList.remove("hide");
              };
              document.getElementsByClassName("error-div")[0].style.display = "block";
              document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center">Passwords Do Not Match</p>`;
              thebutton.prop("disabled", false);
          }

          if (!termsAndConditions.checked) {
              alert('You Must Accept The T&C\'s');
              var elements = document.getElementsByClassName("error-div");
              for (var i = 0; i < elements.length; i++) {
                  elements[i].classList.remove("hide");
              };
              document.getElementsByClassName("error-div")[0].style.display = "block";
              document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center">You Must Accept The T&C's</p>`;
              thebutton.prop("disabled", false);
          }
          else {
              var passwordData = new FormData();
              passwordData.append('first_name', document.querySelector('input[name="first_name"]').value);
              passwordData.append('last_name', document.querySelector('input[name="last_name"]').value);
              passwordData.append('password', document.querySelector('input[name="password"]').value);
              passwordData.append('email', document.querySelector('input[name="email"]').value);

              fetch('/register/set_password/', {
                  method: 'POST',
                  body: passwordData,
                  headers: { 'X-CSRFToken': getCookie('csrftoken') },
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      document.getElementsByClassName("error-div")[0].style.display = "none";
                      window.location.replace("/");
                      thebutton.prop("disabled", false);
                  } else {
                    alert(data.error);
                    var elements = document.getElementsByClassName("error-div");
                    for (var i = 0; i < elements.length; i++) {
                      elements[i].classList.remove("hide");
                    };
                    document.getElementsByClassName("error-div")[0].innerHTML = `<p class="text-center text-white">${data.error}</p>`;
                    document.getElementsByClassName("error-div")[0].style.display = "block";
                    thebutton.prop("disabled", false);
                    window.location.replace("/");
                  }
              });
          }
      }

      var currentTab = 0; // Current tab is set to be the first tab (0)
      showTab(currentTab); // Display the current tab
      
      function showTab(n) {
          // This function will display the specified tab of the form...
          var x = document.getElementsByClassName("tab");
          x[n].style.display = "block";
          //... and fix the Previous/Next buttons:
          if (n == 0) {
          document.getElementById("prevBtn").style.display = "none";
          } else {
          document.getElementById("prevBtn").style.display = "inline";
          }
          if (n == (x.length - 1)) {
          document.getElementById("nextBtn").innerHTML = "Submit";
          } else {
          document.getElementById("nextBtn").innerHTML = "Next";
          }

          //... and run a function that will display the correct step indicator:
          fixStepIndicator(n)
      }
      
      function nextPrev(n) {
          document.getElementsByClassName("error-div")[0].style.display = "none";
          // This function will figure out which tab to display
          var x = document.getElementsByClassName("tab");
          // Exit the function if any field in the current tab is invalid:
          if (n == 1 && !validateForm()) return false;
          // Hide the current tab:
          x[currentTab].style.display = "none";
          // Increase or decrease the current tab by 1:
          currentTab = currentTab + n;
          // if you have reached the end of the form...
          if (currentTab >= x.length) {
          // ... the form gets submitted:
          document.getElementById("regForm").submit();
          return false;
          }
          // Otherwise, display the correct tab:
          showTab(currentTab);
      }
      
      function validateForm() {
          // This function deals with validation of the form fields
          var x, y, i, valid = true;
          x = document.getElementsByClassName("tab");
          y = x[currentTab].getElementsByTagName("input");
          // A loop that checks every input field in the current tab:
          for (i = 0; i < y.length; i++) {
          // If a field is empty...
          if (y[i].value == "") {
              if (currentTab == 0) {
              // add an "invalid" class to the field:
              y[i].className += " invalid";
              // and set the current valid status to false
              valid = false;
              }
              else {
              // add an "invalid" class to the field:
              y[i].className += " valid";
              // and set the current valid status to false
              valid = true;
              }
          }
          }
          // If the valid status is true, mark the step as finished and valid:
          if (valid) {
          document.getElementsByClassName("step")[currentTab].className += " finish";
          }
          return valid; // return the valid status
      }
      
      function fixStepIndicator(n) {
          // This function removes the "active" class of all steps...
          var i, x = document.getElementsByClassName("step");
          for (i = 0; i < x.length; i++) {
          x[i].className = x[i].className.replace(" active", "");
          }
          //... and adds the "active" class on the current step:
          x[n].className += " active";
      }

        
    </script>  
{% endblock %}
